{% extends "base_page.html" %}
{% load wagtailcore_tags static %}

{% block content %}

    {% block breadcrumbs %}
        {% include "navigation/breadcrumbs.html" %}
    {% endblock %}

    <div class="site-padding site-container">
        <div class="relative max-w-[872px] pt-32 tall:pt-40 pb-20">
            <h1 class="font-serif4 font-bold text-7xl lg:text-10xl">
                {{ page.title }}
            </h1>

            <div class="pt-4 pb-3">
                <br>
                <a href="/performances/stats/" 
                style="color: #3b82f6"
                onmouseover="this.style.color='#26899e'"
                onmouseout="this.style.color='#3b82f6'">
                    ğŸ“Š æŸ¥çœ‹æ¼”å‡ºçµ±è¨ˆåˆ†æ
                </a>
            </div>

            {% if page.intro %}
                <p class="max-w-[636px] pt-7 rich-text">
                    {{ page.intro|richtext }}
                </p>
            {% endif %}
        </div>

        <!-- æœå°‹èˆ‡ç¯©é¸ -->
        <form method="get" class="mb-8 space-y-4">
            <!-- é—œéµå­—æœå°‹ -->
            <div class="flex items-center space-x-2 mb-8">
                <label class="font-semibold">é—œéµå­—ï¼š</label>
                <input type="text" name="q" placeholder="åç¨±"
                       value="{{ query|default_if_none:'' }}"
                       class="border border-gray-300 rounded px-3 py-2" />
                
            </div>
            <!-- é€²éšç¯©é¸ -->
            <div class="border border-gray-200 rounded p-4 mb-8">
                <div class="font-semibold mb-6">é€²éšç¯©é¸æ¢ä»¶ <br><br></div>
                <div class="mt-3 flex flex-wrap gap-4">
                    <!-- åŸå¸‚ -->
                    <div>
                        <span class="block font-medium mb-1">åŸå¸‚ï¼š</span>
                        <select name="city" multiple class="border rounded px-2 py-1 min-w-[200px]">
                            {% for city in all_cities %}
                                <option value="{{ city.id }}" {% if city.id|stringformat:"s" in selected_cities %}selected{% endif %}>{{ city.name }}</option>
                            {% endfor %}
                        </select>
                    </div>


                    <!-- é¡å‹  -->
                    <div>
                        <span class="block font-medium mb-1">é¡å‹ï¼š</span>
                        <select name="event_type" multiple class="border rounded px-2 py-1 min-w-[200px]">
                            {% for t in all_types %}
                                <option value="{{ t.id }}" {% if t.id|stringformat:"s" in selected_types %}selected{% endif %}>{{ t.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- æ—¥æœŸæ’åº -->
                    <div>
                        <span class="block font-medium mb-1">æ—¥æœŸæ’åºï¼š</span>
                        <select name="sort" class="border rounded px-2 py-1">
                            <option value="event_date_desc" {% if sort == "event_date_desc" %}selected{% endif %}>æ–° â†’ èˆŠ</option>
                            <option value="event_date_asc" {% if sort == "event_date_asc" %}selected{% endif %}>èˆŠ â†’ æ–°</option>
                        </select>
                    </div>

                    <!-- ===== ä¿®æ”¹ï¼šæ—¥æœŸç¯©é¸ï¼ˆä¸¦æ’é¡¯ç¤ºï¼‰===== -->
                    <div class="min-w-[300px] flex-1">
                        <span class="block font-medium mb-1">æ—¥æœŸç¯©é¸ï¼š</span>
                        <div class="space-y-3">
                            <!-- ç¯©é¸é¡å‹é¸æ“‡ -->
                            <div class="flex flex-wrap gap-3">
                                <label class="flex items-center text-sm">
                                    <input type="radio" name="date_filter_type" value="range" 
                                        {% if date_filter_type == "range" or not date_filter_type %}checked{% endif %}
                                        class="mr-1">
                                    æ—¥æœŸå€é–“
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="radio" name="date_filter_type" value="before" 
                                        {% if date_filter_type == "before" %}checked{% endif %}
                                        class="mr-1">
                                    æ­¤æ—¥æœŸä¹‹å‰
                                </label>
                                <label class="flex items-center text-sm">
                                    <input type="radio" name="date_filter_type" value="after" 
                                        {% if date_filter_type == "after" %}checked{% endif %}
                                        class="mr-1">
                                    æ­¤æ—¥æœŸä¹‹å¾Œ
                                </label>
                            </div>
                            
                            <!-- æ—¥æœŸè¼¸å…¥æ¬„ä½ -->
                            <div class="flex gap-3">
                                <div id="date-from-group" class="flex-1">
                                    <label class="block text-xs mb-1">é–‹å§‹æ—¥æœŸï¼š</label>
                                    <input type="date" name="date_from" 
                                        value="{{ date_from|default_if_none:'' }}"
                                        class="border rounded px-2 py-1 w-full text-sm">
                                </div>
                                <div id="date-to-group" class="flex-1">
                                    <label class="block text-xs mb-1">çµæŸæ—¥æœŸï¼š</label>
                                    <input type="date" name="date_to" 
                                        value="{{ date_to|default_if_none:'' }}"
                                        class="border rounded px-2 py-1 w-full text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ===== æ—¥æœŸç¯©é¸çµæŸ ===== -->

                </div>
            </div>
            <button type="submit"
                        class="ml-2 px-4 py-2 border border-gray-500 text-gray-800 bg-white hover:bg-gray-100 rounded">
                    æœå°‹/ç¯©é¸
            </button>
            <a href="{% pageurl page %}"
                class="ml-2 px-4 py-2 border border-gray-300 text-gray-600 bg-gray-50 hover:bg-gray-100 rounded">
                å–æ¶ˆæ‰€æœ‰é¸å–
            </a>
            <!--<button type="submit">å¥—ç”¨ç¯©é¸</button>-->
            <!--class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"-->
        </form>

        <!-- è¡¨æ ¼ -->
        <div class="overflow-x-auto">
            <table class="w-full table-auto border-collapse border border-gray-300 text-left">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border">æ—¥æœŸ</th>
                        <th class="p-2 border">æ´»å‹•åç¨±</th>
                        <th class="p-2 border">é¡å‹</th>
                        <th class="p-2 border">åœ°é»</th>
                        <th class="p-2 border">åŸå¸‚</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in performances %}
                        <tr class="hover:bg-gray-50">
                            <td class="p-2 border">{{ p.event_date|date:"Y/m/d" }}</td>
                            <td class="p-2 border">{{ p.event_name }}</td>
                            <td class="p-2 border">{{ p.event_type }}</td>
                            <td class="p-2 border">{{ p.venue }}</td>
                            <td class="p-2 border">{{ p.city }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="5" class="p-4 text-center">å°šç„¡è¡¨æ¼”è³‡æ–™</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- ===== æ—¥æœŸå€é–“æª¢æŸ¥ JavaScript ===== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateFilterRadios = document.querySelectorAll('input[name="date_filter_type"]');
    const dateFromGroup = document.getElementById('date-from-group');
    const dateToGroup = document.getElementById('date-to-group');
    const dateFromLabel = dateFromGroup.querySelector('label');
    const dateToLabel = dateToGroup.querySelector('label');
    
    function updateDateFields() {
        const selectedType = document.querySelector('input[name="date_filter_type"]:checked').value;
        const dateFromInput = dateFromGroup.querySelector('input[type="date"]');
        const dateToInput = dateToGroup.querySelector('input[type="date"]');
        
        if (selectedType === 'range') {
            // æ—¥æœŸå€é–“ï¼šé¡¯ç¤ºé–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸ
            dateFromGroup.style.display = 'block';
            dateToGroup.style.display = 'block';
            dateFromLabel.textContent = 'é–‹å§‹æ—¥æœŸï¼š';
            dateToLabel.textContent = 'çµæŸæ—¥æœŸï¼š';
            // ===== æ–°å¢é˜²å‘†ï¼šçµæŸæ—¥æœŸä¸å¾—æ—©æ–¼é–‹å§‹æ—¥æœŸ =====
            if (dateFromInput && dateToInput) {
                dateToInput.min = dateFromInput.value || '';
            }
        } else if (selectedType === 'before') {
            // æ­¤æ—¥æœŸä¹‹å‰ï¼šåªé¡¯ç¤ºçµæŸæ—¥æœŸ
            dateFromGroup.style.display = 'none';
            dateToGroup.style.display = 'block';
            dateToLabel.textContent = 'æ­¤æ—¥æœŸä¹‹å‰ï¼š';
            if (dateToInput) dateToInput.min = '';
        } else if (selectedType === 'after') {
            // æ­¤æ—¥æœŸä¹‹å¾Œï¼šåªé¡¯ç¤ºé–‹å§‹æ—¥æœŸ
            dateFromGroup.style.display = 'block';
            dateToGroup.style.display = 'none';
            dateFromLabel.textContent = 'æ­¤æ—¥æœŸä¹‹å¾Œï¼š';
        }
    }
    
    // åˆå§‹åŒ–
    updateDateFields();
    
    // ç›£è½è®ŠåŒ–
    dateFilterRadios.forEach(radio => {
        radio.addEventListener('change', updateDateFields);
    });
    // ===== æ–°å¢ï¼šç›£è½é–‹å§‹æ—¥æœŸè®ŠåŒ–ï¼Œå‹•æ…‹èª¿æ•´çµæŸæ—¥æœŸ min =====
    const dateFromInput = dateFromGroup.querySelector('input[type="date"]');
    const dateToInput = dateToGroup.querySelector('input[type="date"]');
    if (dateFromInput && dateToInput) {
        dateFromInput.addEventListener('change', function() {
            if (document.querySelector('input[name="date_filter_type"]:checked').value === 'range') {
                dateToInput.min = dateFromInput.value || '';
                // è‹¥çµæŸæ—¥æœŸå·²é¸ä¸”æ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œè‡ªå‹•æ¸…ç©º
                if (dateToInput.value && dateToInput.value < dateFromInput.value) {
                    dateToInput.value = '';
                }
            }
        });
    }
});
</script>
<!-- ===== æ—¥æœŸå€é–“æª¢æŸ¥ JavaScript çµæŸ ===== -->

{% endblock %}